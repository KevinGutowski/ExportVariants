<style>
  details > summary {
    list-style: none;
  }
  details > summary::-webkit-details-marker {
    display: none;
  }

  body {
    font-family: Inter, sans-serif;
    font-feature-settings: "liga", "calt";
    font-size: 14px;
  }

  p {
    line-height: 1.3;
    margin: 0;
    margin-bottom: 4px;
  }

  .propertySetting {
    margin-top: 12px;
  }

  .propertySetting > p {
    font-weight: 600;
  }

  #exampleText {
    padding: 4px 12px;
    background-color: rgba(0,0,0,0.06);
    color: rgba(0,0,0,0.8);
    border-radius: 4px;
    margin-top: 8px;
  }

  #export {
    margin-top: 8px;
  }

  input[type=radio] {
    position: relative;
    top: 1px;
    margin-left: 0;
  }

  .propertySetting > label:not(:last-child) {
    margin-right: 4px;
  }
</style>

<p id='layerText'>Nothing selected</p>
<p id="itemsToExport"></p>


<div class="propertySetting">
  <p>Use variant names for</p>
  <label for="folders"><input type="radio" name="propertySetting" value="folders" id="folders" checked onclick="updateDisplayOfExampleOutput()">Folders</label>
  <label for="filenames"><input type="radio" name="propertySetting" value="filenames" id="filenames" onclick="updateDisplayOfExampleOutput()">Files names</label>
</div>

<p id="exampleText"></p>


<button id="export">Export</button>
<script>

let layerText = document.getElementById('layerText')
let folderOption = document.getElementById('folders')
let filenameOption = document.getElementById('filenames')
let exampleText = document.getElementById('exampleText')
let exportButton = document.getElementById('export')
let exportCountText = document.getElementById('itemsToExport')

let exampleTextOptions = ["",""]
// first option is the example text for folders
// {prop_x.variant_x}-{prop_y.variant_y}-{prop_z.variant_z}/{component_name}.svg
// section option is the example text for filenames
// {component_name}-{prop_x.variant_x}-{prop_y.variant_y}-{prop_z.variant_z}.svg

onmessage = (event) => {
  let messageType = event.data.pluginMessage.type
  if (messageType === 'setup') {
    let preference = event.data.pluginMessage.preference
    
    if (preference === 'filenames') {
      filenameOption.checked = true
      folderOption.checked = false
    }
  }

  if (messageType === 'selectionChange' || messageType === 'setup') {
    let message = event.data.pluginMessage
    if (message.data != null) {
      let numberOfComponentSets = message.data.componentSetsLength
      layerText.innerHTML = `Number of Component Sets: ${numberOfComponentSets}`

      if (numberOfComponentSets < 1) {
        exampleText.innerHTML = ""
        exportCountText.innerHTML = ""
        exportButton.disabled = true
      } else {
        updateTextOfExampleOutput(message.data.firstComponentSet.metaData)
        exportCountText.innerHTML = `Number of variants: ${message.data.numberOfComponents}`
        exportButton.disabled = false
      }
    } else {
      layerText.innerHTML = "Nothing selected"
      exampleText.innerHTML = ""
      exportCountText.innerHTML = ""
      exportButton.disabled = true
    }
  }

  if (messageType === 'download') {
    let message = event.data.pluginMessage
    // perform download
    exportButton.disabled = false
    console.log(`perform download with data ${message.data}`)
  }
}

function updateDisplayOfExampleOutput() {
  // looks at radioOptions and swaps to the proper text option
  let preference

  if (filenameOption.checked) {
    exampleText.innerHTML = exampleTextOptions[1]
    preference = 'filenames'
  } else {
    exampleText.innerHTML = exampleTextOptions[0]
    preference = 'folders'
  }

  parent.postMessage({ pluginMessage: { type: 'preference', preference } }, '*')
}

function updateTextOfExampleOutput(metaData) {
  // Updates the example text array
  let name = metaData.name
  let fileNameString = name

  let combinedVariants = ""
  metaData.variants.forEach(variant=>{
    let bools = ["yes", "no", "true", "false"]
    if (bools.indexOf(variant.toLowerCase()) === -1) {
      combinedVariants += `-${variant.toLowerCase()}`
    }
  })
  exampleTextOptions[0] = `${combinedVariants.substring(1)}/${name}.svg`
  exampleTextOptions[1] = `${name}${combinedVariants}.svg`

  updateDisplayOfExampleOutput()
}

exportButton.onclick = () => {
  let selection
  if (filenameOption.checked) { selection = 'filenames'} else { selection = 'folders'}
  parent.postMessage({ pluginMessage: { type: 'export', selection } }, '*')
  exportButton.disabled = true
}

</script>
